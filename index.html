<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <link rel="shortcut icon" href="data:image/x-icon;base64,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" type="image/x-icon">
    <title>Favi</title>
    <style>
      html {
        font-family: system-ui, helvetica, sans-serif;
      }

      body {
        padding: 2rem;
        margin: 0 auto;
        width: fit-content;
        display: grid;
        gap: 1.5rem;
      }

      canvas {
        outline: 1px solid black;
      }

      .flex {
        display: flex;
        gap: 1rem;
        align-items: end;
        padding: 0.5rem 0;
      }

      #save {
        float: right;
      }
    </style>
  </head>
  <body>
    <h1>Favi</h1>
    <input
      type="file"
      name="open"
      id="upload"
      accept="image/apng, image/bmp, image/gif, image/jpeg, image/pjpeg, image/png, image/svg+xml, image/tiff, image/webp, image/x-icon"
      required
    >
    <div class="flex">
      <canvas id="can64" width="64px" height="64px"></canvas>
      <canvas id="can48" width="48px" height="48px"></canvas>
      <canvas id="can32" width="32px" height="32px"></canvas>
      <canvas id="can24" width="24px" height="24px"></canvas>
      <canvas id="can16" width="16px" height="16px"></canvas>
    </div>
    <div><input type="button" id="save" value="Save" disabled></div>
    <script type="module">
      // Canvas per size
      const can64 = document.getElementById("can64");
      const can48 = document.getElementById("can48");
      const can32 = document.getElementById("can32");
      const can24 = document.getElementById("can24");
      const can16 = document.getElementById("can16");
      // Drawing Contexts
      const ctx64 = can64.getContext("2d");
      const ctx48 = can48.getContext("2d");
      const ctx32 = can32.getContext("2d");
      const ctx24 = can24.getContext("2d");
      const ctx16 = can16.getContext("2d");
      // Holds image
      const photo = new Image();
      const upload = document.getElementById("upload");
      upload.addEventListener("change", (e) => {
        if (!upload.files || upload.files.length < 1) {
            alert("No image files selected.");
            return;
        }
        if (upload.files.length > 1) {
            alert("One image file at a time.");
            return;
        }
        // User picked a file
        const file = upload.files[0];
        // Load into image
        const url = URL.createObjectURL(file);
        photo.src = url;
        photo.onload = () => {
            ctx64.drawImage(photo, 0, 0);
            ctx48.drawImage(photo, 0, 0);
            ctx32.drawImage(photo, 0, 0);
            ctx24.drawImage(photo, 0, 0);
            ctx16.drawImage(photo, 0, 0);
            // enable download button
            save.disabled = false;          
        };
      });

      // Write all bytes in .ico format
      function saveIco(blobs) {
        const header_size = 5 * 16 + 6;
        const buf = new ArrayBuffer(header_size);
        const view = new DataView(buf);
        var idx = 0;
        const LE = true; // little endian
        // Ico Header
        view.setInt16(idx, 0, LE); // reserved
        idx += 2;
        view.setInt16(idx, 1, LE); // .ico id
        idx += 2;
        view.setInt16(idx, 5, LE); // num infos
        idx += 2;
        // Image Infos
        const sizes = [16, 24, 32, 48, 64];
        var offset = header_size;
        for (let i = 0; i < 5; i++) {
            view.setInt8(idx, sizes[i], LE); // w
            idx += 1;
            view.setInt8(idx, sizes[i], LE); // h
            idx += 1;
            view.setInt8(idx, 0, LE); // pallette
            idx += 1;
            view.setInt8(idx, 0, LE); // reserved
            idx += 1;
            view.setInt16(idx, 1, LE); // planes
            idx += 2;
            view.setInt16(idx, 32, LE); // depth
            idx += 2;
            view.setInt32(idx, blobs[i].size, LE);
            idx += 4;
            view.setInt32(idx, offset, LE);
            idx += 4;
            offset += blobs[i].size;
        }
        // Assemble final bytes
        const data = new Blob([buf, ...blobs], { type: "image/x-icon" })
        const reader = new FileReader();
        reader.addEventListener(
          "load",
          () => { // convert to data url for download
            const url = reader.result;
            console.log(url); // useful for to embed icon (see <head>)
            // Download bytes as "favicon.ico"
            const link = document.createElement("a");
            link.href = url;
            link.download = "favicon.ico";
            link.click();
          },
          false,
        );
        reader.readAsDataURL(data);
      }

      const save = document.getElementById("save");
      save.addEventListener("click", () => {
        // start loading the biggest blobs first 
        const sizes = [64, 48, 32, 24, 16];
        const canvas_list = [can64, can48, can32, can24, can16];
        const blobs = new Array(5);
        var count = 0
        for (let i = 0; i < 5; i++) {
          canvas_list[i].toBlob((blob) => { 
            // .ico convention is to put blobs small to large
            blobs[4-i] = blob; // so reverse blob the order
            count += 1;
            if (count == 5) { // when the all blobs are ready
              saveIco(blobs) // write bytes in .ico format
            }
          },"image/png");
        }
      });
    </script>
  </body>
</html>